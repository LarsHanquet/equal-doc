## Introduction

eQual allows to attach URIs to any kind of operation defined in controllers, which are regular PHP scripts.

Within a package, controllers are stored inside the `actions`, `data` & `apps` folders. 

eQual follows the CQRS architectural pattern (Command-Query Responsibility Separation) :


| **FOLDER** | **OPERATION**                                                |
| ---------- | ------------------------------------------------------------ |
| actions    | **"DO"** operations (POST, PUT, PATCH, DELETE) : Processing operations involving data manipulation (Commands). |
| data       | **"GET"** operations (GET) : data providers answering to request (Queries). |
| apps       | **"SHOW"** operations : output involving UI data generated by the back-end (mostly Apps). |

!!! note "About Controllers"
    * Controllers are re-usable and can be interdependent.
    * Controllers can act as data funnels and dispatchers.

### Data providers

**GET**: in charge of retrieving and querying data (READ operations). They're located in `packages/{package}/data`.

### Action handlers

**DO**: in charge of performing operations and modifications (CREATE, UPDATE, DELETE). They're located in `packages/{package}/actions`.

### Application providers

**SHOW**: in charge of server-side rendering. They're located in `packages/{package}/apps`.

## Controller Anatomy

### Announcement

- `description`
	* What it does

	* Expected parameters and related characteristics

	* Constraints, default value, optional or mandatory; type; name; description

- dependency injection services required by the script

- response format : content-type and content-disposition (charset)

- CORS : accept-origin (Access-Control-Allow-Origin)

### `description`

Describes what the controller does.

### `params`

Array containing values used by the controller, which may be required.

### `constants`

List of `strings`, representing constant names, used by the system.

They are present globally inside the `config/config.inc.php` file, but also can be overwritten (with the **namespace `config`**) inside packages with a `config.inc.php` file.

Every overwritten constant is limited to the package it belongs to.

If they are used by a controller, they must be listed by it. If there is an error, displays `Error 500`.

Example :

``` php
'constants'     => ['AUTH_ACCESS_TOKEN_VALIDITY', 'AUTH_REFRESH_TOKEN_VALIDITY', 'AUTH_TOKEN_HTTPS']    
```

The constants are checked by the `announce()` function inside `eq.lib.php`.

### `access`

The `access` property allows to quickly define rights management: making sure the user performing a request has the required permissions.


| **PROPERTY** | **DESCRIPTION**                                              |
| ------------ | ------------------------------------------------------------ |
| `'visibility'`   | The level of "visibility" of the controller ('public', 'protected' or 'private'). |
|`'groups'`       | An array holding the list of groups the view is restricted to. |



Examples : 


```php
<?php
'access' => [
  'visibility'  => 'public'					
   // anyone can access the controller (anonymous users)
]
```

```php
<?php
'access' => [
  'visibility'  => 'protected',
  'users'       => [ROOT_USER_ID],           // list of granted users ids  
]
```

```php
<?php
'access' => [
  'visibility'  => 'protected',
  'groups'      => ['sales.bookings.users'], // list of granted groups names
]
```

### `response`

The `response` property provides info about the format of the returned data (if any).

It also allows to restrict the accepted origins of the requests (using CORS). At the moment the origin is unlimited, it is possible to create an array with the URL allowed to access the API.

```php
<?php
'response' => [
  'content-type'    => 'application/json',
  'charset'         => 'utf-8',
  'accept-origin'   => '*'
],
```

### `providers`

List of the different providers/services needed by the controller.

Example: 

```php
<?php 
'providers'   => ['context', 'orm' , 'auth']     
 //'orm'= ObjectManager & 'auth'=AuthentificationManager
```

### `examples`
The controller announcement allows the description of an `examples` property, in the form of an associative array intended for providing example calls.

This property is optional but valuable for frequently used controllers. When defined, by convention, it includes one example per call type. Each example corresponds to a key in the map: `CLI`, `HTTP`, and `PHP`.

Example:
```php
'examples' => [
    'CLI'   => './equal.run --get=contractika_sd_absences --id=16',
    'HTTP'  => '/?get=contractika_sd_absences&id=16',
    'PHP'   => "eQual::run('get', 'contractika_sd_absences', ['id' => 16]);"
],
```

## `CLI` calls

When invoking controllers through CLI, parameters can be provided using long options notation :  `--arg=param` (as handled by `getopt_long()`).

As the command will be interpreted by bash and that special chars might be involved in the parameters values, it might be necessary to encapsulate values within double quotes.

Example:

```bash
./equal.run --get=model_collect --entity=core\\User --domain="[id,>,100]" --limit=500 --fields="{id,points}"
```

# Router 

The Router `equal/route/Router.class.php` class handles routes located inside the `config/routing` folder.

The routing mechanism is meant to route a request to the targeted controller.

Structure of a route  :	`URI -> operation`

Reserved parameters :

- `get`

- `do`

- `show`

- `route`

- `announce`

## Creating Routes

Inside the `config/routing` directory, you have the possibility to build your own routes. 

The expected route structure :

| **STRUCTURE** | **TYPE**                                                     | **DESCRIPTION** |
| --------------- | -----------------------------------------|------------------ |
| method | string         | HTTP method, example: "GET", "POST", "PUT", "DELETE", "PATCH". |
| path | string | Full path of the requested URI. |
| parts | array |Array of parts composing the path.|
| operation | string |The operation the URI resolves to.|
| params | array |Map of parameters names as keys, related to their values.|



There are a few default routes built in eQual, to get the users and groups.

**Example**  : 

```JSON
"/user/:ids": {
        "GET": {
            "description": "Retrieve fields values related to a given user",
            "operation": "?get=core_model_read&entity=core\\User"
        },
        "PUT": {
            "description": "Update a user",
            "operation": "?do=core_user_update"
        },
        "DELETE": {
            "description": "Delete a user",
            "operation": "?do=core_model_delete&entity=core\\User"
        }
    },
```

You need the operation and description properties to build your routes. 

The **operation** will be about the "Query" part of the URI/URL. 

And the description is simply a field to indicate what the operation does.



##### routes hierarchy

Routes are stored in files located in th the `config/routing` folder. 

The files holding the routes configuration are read in alphabetical order. Which means, that if two distinct files contain a same route (targeting different controllers), it is the route that is contained in the first file, in alphabetical order, that will be applied.

Typically, when a package needs to override an existing route, it uses files with a prefix having a higher priority.

Example: 

```
/routing
  10-lodging.json
  80-documents.json
  80-identity.json
  99-default.json
```



##### i18n

Inside the `config/routing` folder, you can have sub-folders for different languages, with the possibility to translate the routes in the chosen language.
